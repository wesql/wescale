---
标题: WeScale简介
---

# 引言
数据库代理是开发人员和数据库管理员提高应用程序可扩展性、性能、安全性和弹性的关键工具。

WeSQL WeScale 是一个高度兼容 MySQL 的数据库代理。它支持MySQL协议、读写分离、连接池化以及透明failover。本文将为您介绍 WeSQL WeScale，解释其架构、关键功能及其优势，帮助您了解为什么要使用它。

# 架构
WeSQL WeScale 是 Vitess 项目的一个分支，我们移除了分片支持，以换取更好的 SQL 兼容性，例如更好地支持子查询、公共表表达式（CTE）和表达式计算。下图展示了 WeSQL WeScale 集群的架构。

**VTGate**: 客户端应用程序通常通过标准 MySQL 协议连接到 VTGate。VTGate 是无状态的，这意味着它可以轻松有效地在规模和性能上进行扩展。它的作用类似于 MySQL，负责解析 SQL 查询，并将查询规划和路由到 VTTables。

**VTTablet**: 通常，VTTablet 作为 MySQL 的 sidecar 实现。如果 WeSQL WeScale 部署在 Kubernetes 中，那么 VTTablet 应该与 MySQL 位于同一个 Pod 中。VTTablet 接受来自 VTGate 的 gRPC 请求，然后将这些查询发送到 MySQL 执行。VTTablet 负责一些任务，如权限检查和日志记录，但其最关键的角色是确保正确的连接池管理。

**VTController**: VTController 组件促进 VTGate 和 VTTablet 之间的服务发现，同时使它们能够存储集群的元数据。如果 MySQL 的角色发生变化，例如从主节点变为从节点，那么相应的 VTTablet 角色也应随之改变。VTController 检查 MySQL 集群的状态，并向 VTTablet 发送命令，请求其更改角色。
![](images/16922377805654.jpg)

# 连接池化
数据库连接消耗内存，为确保缓冲池有足够的内存，数据库限制了 'max_connections' 的值。由于应用程序通常是无状态的，可能需要快速扩展，因此可能会创建大量连接，这很容易使数据库超载。因此，这类应用程序不适合直接连接到 MySQL 服务器并创建连接池。

使用 WeSQL WeScale，应用程序可以根据需要创建任意数量的连接，而无需担心 max_connection 错误。因为 WeSQL WeScale 将接管数据库的连接池建立，允许应用程序在 MySQL 服务器端共享和重用连接。这减少了在 MySQL 服务器端打开和关闭连接所带来的内存和 CPU 开销，从而提高了可扩展性和性能。

# 读写分离
使用只读节点可以显著减轻主数据库节点的工作负载，并提高资源利用率。然而，管理多个只读节点并决定何时使用每个节点对应用程序来说可能是一个挑战。WeSQL WeScale 通过提供三项关键功能来解决这一问题：读写分离、写后读一致性和负载均衡。这些功能使应用程序更容易有效利用只读节点。

**读写分离**: WeSQL WeScale 通过自动将读取查询路由到只读节点，将写入查询路由到主节点，从而简化了应用程序逻辑。这是通过解析和分析 SQL 语句来实现的，从而改进了负载均衡，并确保了资源的高效使用。

**写后读一致性**: 这一功能与读写分离配合使用，以在保持性能提升的同时维护数据一致性。当应用程序向主节点写入数据并随后在只读节点上读取时，WeSQL WeScale 确保能够从只读节点访问并读取刚刚写入主节点的数据。

**负载均衡**: WeSQL WeScale 通过使用各种负载均衡策略将查询路由到合适的节点，帮助管理只读节点。这确保了工作负载在所有可用节点上均匀分布，从而优化性能和资源利用率。

# failover
failover是一种确保当原始数据库实例不可用时，由另一个实例替代并保持高可用性的功能。各种因素都可能触发failover事件，包括数据库实例的问题或数据库升级等计划内维护程序。

没有 WeSQL WeScale 的情况下，failover需要短暂的停机时间。现有的数据库连接会断开，应用程序需要重新打开连接。WeSQL WeScale 能够自动检测到failover，并在内存中缓存应用程序的 SQL，同时保持应用程序连接的完整性，从而在数据库故障的情况下增强应用程序的弹性。

尽管无法完全解决应用程序端连接错误的问题，但代理是无状态的，可以通过多节点部署实现高可用性。此外，重启/恢复通常比数据库快得多，因为它不需要从撤销日志和重做日志中恢复。

# 未来计划
数据库的出现是为了满足应用程序的共性需求。然而，应用技术的发展已经显著超越了传统数据库内核的发展。除了上述优势外，我们还计划实施更多功能，以使数据库对应用程序更加友好。这包括代理端身份验证和授权、SQL 节流、Online DDL 等。

# 总结
如果在阅读上述内容后仍有疑问，这里有一个简单的检查表，可以帮助您判断是否可以从 WeSQL WeScale 中受益：
1. 您的数据库实例遇到了“连接过多”错误。
2. 您的应用程序维护了大量长期连接。
3. 您的应用程序需要快速扩展，导致数据库连接激增。
4. 您的应用程序需要使用读写分离，并希望确保一致性。
5. 您的数据库实例需要进行维护操作（如升级），而应用程序无法承受任何停机时间。

总之，WeSQL WeScale 是一个强大的数据库代理，可以显著提高应用程序的可扩展性、性能、安全性和弹性。它通过有效的连接管理、读写分离和一致性、负载均衡以及透明failover功能，帮助解决数据库连接问题并提高资源利用率。